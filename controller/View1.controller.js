sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/core/util/Export","sap/ui/core/util/ExportTypeCSV","sap/ui/core/library"],function(e,t,i,a,s,n,r){"use strict";var l=new t;var o=r.ValueState;var u;var c;var m={catList:[]};var d={newList:[]};var M={zList:[]};var g={carrList:[]};return e.extend("com.qb2i4.qb2i4.controller.View1",{onInit:function(){sap.ui.core.BusyIndicator.show(10);var e=this.getView().getModel("modA");var t=this;e.read("/YY1_Pur_req_MRP",{async:false,success:function(e,i){var a=e.results;c=a.length;var s=a.length;for(var n=0;n<s;n++){u=n;m.catList.push({PurchaseRequisition:a[n].PurchaseRequisition,PurchaseRequisitionItem:a[n].PurchaseRequisitionItem,Plant:a[n].Plant,Material:a[n].Material,DeliveryDate:a[n].DeliveryDate,RequestedDeliveryDate:a[n].RequestedDeliveryDate,CreationDate:a[n].CreationDate,AccountAssignmentCategory:a[n].AccountAssignmentCategory});if(c===u+1&&c!==undefined&&u!==undefined){t.abcd()}}sap.ui.core.BusyIndicator.hide()},error:function(e){}})},abcd:function(){for(var e=0;e<m.catList.length;e++){g.carrList[e]=m.catList[e].Plant}var t=g.carrList.filter(function(e,t,i){return i.indexOf(e)===t});this.h=t;var i={pList:[]};for(var a=0;a<t.length;a++){i.pList.push({Plant:t[a]})}var s=new sap.ui.model.json.JSONModel;s.setData(i);this.getView().setModel(s)},handleChange:function(e){var t=e.getParameter("from"),i=e.getParameter("to");this.bValid=e.getParameter("valid");t=JSON.stringify(t);this.from=t.slice(1,11);i=JSON.stringify(i);this.to=i.slice(1,11);this.getView().byId("mb").setValue(null)},funcA:function(e){var t=this;if(this.from===undefined||this.to===undefined){jQuery.sap.require("sap.m.MessageBox");sap.m.MessageBox.show("Please Select Date Range",{icon:sap.m.MessageBox.Icon.WARNING,title:"Dear User",actions:[sap.m.MessageBox.Action.YES],onClose:function(e){if(e==="YES"){t.getView().byId("mb").setValue(null);return}}})}else{sap.ui.core.BusyIndicator.show();var i=this.getView().getModel("modB");var a=e.getParameter("value");this.pcheck=a;var s=new Array;for(var n=0;n<m.catList.length;n++){var r=JSON.stringify(m.catList[n].CreationDate);r=r.slice(1,11);if(m.catList[n].Plant===a&&r<=this.to&&r>=this.from){d.newList.push({PurchaseRequisition:m.catList[n].PurchaseRequisition,PurchaseRequisitionItem:m.catList[n].PurchaseRequisitionItem,Plant:m.catList[n].Plant,Material:m.catList[n].Material,DeliveryDate:m.catList[n].DeliveryDate,RequestedDeliveryDate:m.catList[n].RequestedDeliveryDate,AccountAssignmentCategory:m.catList[n].AccountAssignmentCategory})}}if(d.newList.length===0||d.newList.length===undefined){sap.ui.core.BusyIndicator.hide();var l=new sap.ui.model.json.JSONModel;this.getView().setModel(l,"MRP");t=this;jQuery.sap.require("sap.m.MessageBox");sap.m.MessageBox.show("No Records Found for date "+this.from+" to "+this.to,{icon:sap.m.MessageBox.Icon.ERROR,title:"Dear User",actions:[sap.m.MessageBox.Action.YES],onClose:function(e){if(e==="YES"){t.getView().byId("mb").setValue(null);return}}})}else{for(var o=0;o<d.newList.length;o++){if(d.newList[o].AccountAssignmentCategory!=="Y"){s[o]=d.newList[o].Material}}var u=s.filter(function(e,t,i){return i.indexOf(e)===t});var c=new sap.ui.model.Filter("MRPPlant",sap.ui.model.FilterOperator.EQ,a);var g=new sap.ui.model.Filter({filters:[c],and:true});var v=[];for(var R=0;R<u.length;R++){v.push(new sap.ui.model.Filter("Material",sap.ui.model.FilterOperator.EQ,u[R]))}var P=new sap.ui.model.Filter({filters:v,and:false});var h=new Array(new sap.ui.model.Filter({filters:[g,P],and:true}));i.read("/SupplyDemandItems",{async:false,filters:[h],success:function(e,t){var i=e.results;var a=i.length;for(var s=0;s<a;s++){M.zList.push({MRPElementCategoryName:i[s].MRPElementCategoryName,SourceMRPElementItem:i[s].SourceMRPElementItem,SourceMRPElement:i[s].SourceMRPElement,Material:i[s].Material,MRPPlant:i[s].MRPPlant,MRPElementAvailyOrRqmtDate:i[s].MRPElementAvailyOrRqmtDate,ExceptionMessageText:i[s].ExceptionMessageText});sap.ui.core.BusyIndicator.hide()}},error:function(e){sap.ui.core.BusyIndicator.hide()}})}}},onShow:function(){var e=this.getView().byId("mb").getValue();if(this.bValid===undefined||this.bValid===false||e===undefined||e===""){sap.m.MessageToast.show("Please select valid Details");return}else{var t=new Array;var i=new Array;var a=new Array;var s=this.getView().byId("btnId");s.setBusy(true);s.setBusyIndicatorDelay(0);for(var n=0;n<d.newList.length;n++){t[n]=d.newList[n].PurchaseRequisition;i[n]=d.newList[n].PurchaseRequisitionItem}var r=t.filter(function(e,t,i){return i.indexOf(e)===t});var o=i.filter(function(e,t,i){return i.indexOf(e)===t});for(var u=0;u<o.length;u++){a[u]=parseInt(o[u],10)}a=a.map(String);var c={yList:[]};var m={jList:[]};s.setBusy(true);for(var g=0;g<r.length;g++){for(var v=0;v<M.zList.length;v++){if(r[g]===M.zList[v].SourceMRPElement&&M.zList[v].MRPElementCategoryName==="Purchase requisition"){c.yList.push({MRPElementCategoryName:M.zList[v].MRPElementCategoryName,SourceMRPElementItem:M.zList[v].SourceMRPElementItem,SourceMRPElement:M.zList[v].SourceMRPElement,Material:M.zList[v].Material,MRPPlant:M.zList[v].MRPPlant,MRPElementAvailyOrRqmtDate:M.zList[v].MRPElementAvailyOrRqmtDate,ExceptionMessageText:M.zList[v].ExceptionMessageText})}}}for(var R=0;R<a.length;R++){for(var P=0;P<c.yList.length;P++){if(a[R]===c.yList[P].SourceMRPElementItem){m.jList.push({MRPElementCategoryName:c.yList[P].MRPElementCategoryName,SourceMRPElementItem:c.yList[P].SourceMRPElementItem,SourceMRPElement:c.yList[P].SourceMRPElement,MRPElementAvailyOrRqmtDate:c.yList[P].MRPElementAvailyOrRqmtDate,Material:c.yList[P].Material,MRPPlant:c.yList[P].MRPPlant,ExceptionMessageText:c.yList[P].ExceptionMessageText})}}}var h={finalList:[]};for(var f=0;f<m.jList.length;f++){for(var y=0;y<d.newList.length;y++){if(m.jList[f].SourceMRPElement===d.newList[y].PurchaseRequisition){var p=JSON.stringify(m.jList[f].MRPElementAvailyOrRqmtDate);p=p.slice(1,11);var L=JSON.stringify(d.newList[y].DeliveryDate);L=L.slice(1,11);if(d.newList[y].RequestedDeliveryDate===null){var w}else{w=JSON.stringify(d.newList[y].RequestedDeliveryDate);w=w.slice(1,11)}h.finalList.push({DeliveryDate:L,MRPElementCategoryName:m.jList[f].MRPElementCategoryName,SourceMRPElementItem:m.jList[f].SourceMRPElementItem,SourceMRPElement:m.jList[f].SourceMRPElement,MRPElementAvailyOrRqmtDate:p,Material:m.jList[f].Material,MRPPlant:m.jList[f].MRPPlant,RequestedDeliveryDate:w,ExceptionMessageText:m.jList[f].ExceptionMessageText})}if(m.jList[f].SourceMRPElement===d.newList[y].PurchaseRequisition){break}}}s.setBusy(false);if(m.jList.length<=0||m.jList.length===undefined){sap.m.MessageToast.show("No Records Found");var E=new sap.ui.model.json.JSONModel;this.getView().setModel(E,"MRP")}else{l.setData(h);l.setSizeLimit(1e6);this.getView().setModel(l,"MRP");d.newList.splice(0,d.newList.length);M.zList.splice(0,M.zList.length);m.jList.splice(0,m.jList.length)}}},onReset:function(e){var t=" ";this.getView().byId("Plant").setValue(t);this.getView().byId("DRS3").setValue(t)},onClear:function(e){var t=" ";this.getView().byId("Plant").setValue(t);this.getView().byId("DRS3").setValue(t)},onOpen:function(){var e=this.getView().getModel("i18n").getResourceBundle();var t=e.getText("Login").toString().trim();window.open(t,"_blank")},onDataExport:function(){var e=this.getView().getModel("MRP");var t=new s({exportType:new n({charset:"utf-8",fileExtension:"csv",separatorChar:",",mimeType:"application/csv"}),models:e,rows:{path:"/finalList"},columns:[{name:"PR",template:{content:"{SourceMRPElement}"}},{name:"PR Item",template:{content:"{SourceMRPElementItem}"}},{name:"Plant",template:{content:"{MRPPlant}"}},{name:"Material",template:{content:"{Material}"}},{name:"Actual need date",template:{content:"{MRPElementAvailyOrRqmtDate}"}},{name:"Requested Delivery Date",template:{content:"{RequestedDeliveryDate}"}},{name:"Delivery Date",template:{content:"{DeliveryDate}"}}]});t.saveFile().catch(function(e){sap.m.MessageToast.show("Error")}).then(function(){t.destroy()})}})});