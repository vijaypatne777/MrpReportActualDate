sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/core/util/Export","sap/ui/core/util/ExportTypeCSV","sap/ui/core/library","sap/m/MessageToast"],function(e,t,i,a,s,r,n,l){"use strict";var o=new t;var u=n.ValueState;var c;var d;var p={catList:[]};var m={pList:[]};var h={newList:[]};var v={zList:[]};var g={carrList:[]};return e.extend("com.qb2i4.qb2i4.controller.View1",{onInit:function(){var e=this;sap.ui.core.BusyIndicator.show();var t=new sap.ui.model.json.JSONModel;var i="/OPENSAP/sap/opu/odata/sap/YY1_PLANT_API_CDS/";var a=new sap.ui.model.odata.ODataModel(i,true);var s="YY1_Plant_API";a.read(s,{async:false,success:function(t,i){var a=t.results;d=a.length;var s=a.length;for(var r=0;r<s;r++){c=r;m.pList.push({Plant:a[r].Plant});if(d===c+1&&d!==undefined&&c!==undefined){e.abcd()}}sap.ui.core.BusyIndicator.hide()},error:function(e){}})},abcd:function(){for(var e=0;e<m.pList.length;e++){g.carrList[e]=m.pList[e].Plant}var t=g.carrList.filter(function(e,t,i){return i.indexOf(e)===t});this.h=t;var i={pList:[]};for(var a=0;a<t.length;a++){i.pList.push({Plant:t[a]})}var s=new sap.ui.model.json.JSONModel;s.setData(i);this.getView().setModel(s);this.getView().byId("mb").setValue(null)},handleChange:function(e){p.catList.splice(0,p.catList.length);h.newList.splice(0,h.newList.length);v.zList.splice(0,v.zList.length);var t=new sap.ui.model.json.JSONModel;this.getView().setModel(t,"MRP");var s=e.getParameter("from"),r=e.getParameter("to");var n=new i({path:"CreationDate",operator:a.BT,value1:s,value2:r});sap.ui.core.BusyIndicator.show();var l=this.getView().getModel("modA");l.read("/YY1_Pur_req_MRP",{filters:[n],async:false,success:function(e,t){var i=e.results;d=i.length;var a=i.length;for(var s=0;s<a;s++){c=s;if(s!==0){var r=s-1}else{r=0;p.catList.push({PurchaseRequisition:i[s].PurchaseRequisition,PurchaseRequisitionItem:i[s].PurchaseRequisitionItem,Plant:i[s].Plant,Material:i[s].Material,DeliveryDate:i[s].DeliveryDate,RequestedDeliveryDate:i[s].RequestedDeliveryDate,CreationDate:i[s].CreationDate,AccountAssignmentCategory:i[s].AccountAssignmentCategory,FixedSupplier:i[s].FixedSupplier,ZZITEM:i[s].ZZITEM})}if(i[s].PurchaseRequisition!==i[r].PurchaseRequisition||i[s].PurchaseRequisitionItem!==i[r].PurchaseRequisitionItem){p.catList.push({PurchaseRequisition:i[s].PurchaseRequisition,PurchaseRequisitionItem:i[s].PurchaseRequisitionItem,Plant:i[s].Plant,Material:i[s].Material,DeliveryDate:i[s].DeliveryDate,RequestedDeliveryDate:i[s].RequestedDeliveryDate,CreationDate:i[s].CreationDate,AccountAssignmentCategory:i[s].AccountAssignmentCategory,FixedSupplier:i[s].FixedSupplier,ZZITEM:i[s].ZZITEM})}}sap.ui.core.BusyIndicator.hide()},error:function(e){}});this.bValid=e.getParameter("valid");s=JSON.stringify(s);this.from=s.slice(1,11);r=JSON.stringify(r);this.to=r.slice(1,11);this.getView().byId("mb").setValue(null)},funcA:function(e){var t=this;h.newList.splice(0,h.newList.length);v.zList.splice(0,v.zList.length);var i=new sap.ui.model.json.JSONModel;this.getView().setModel(i,"MRP");if(this.from===undefined||this.to===undefined){jQuery.sap.require("sap.m.MessageBox");sap.m.MessageBox.show("Please Select Date Range",{icon:sap.m.MessageBox.Icon.WARNING,title:"Dear User",actions:[sap.m.MessageBox.Action.YES],onClose:function(e){if(e==="YES"){t.getView().byId("mb").setValue(null);return}}})}else{sap.ui.core.BusyIndicator.show();var a=this.getView().getModel("modB");var s=e.getParameter("value");this.pcheck=s;var r=new Array;for(var n=0;n<p.catList.length;n++){var l=JSON.stringify(p.catList[n].CreationDate);l=l.slice(1,11);if(p.catList[n].Plant===s){h.newList.push({PurchaseRequisition:p.catList[n].PurchaseRequisition,PurchaseRequisitionItem:p.catList[n].PurchaseRequisitionItem,Plant:p.catList[n].Plant,Material:p.catList[n].Material,DeliveryDate:p.catList[n].DeliveryDate,RequestedDeliveryDate:p.catList[n].RequestedDeliveryDate,AccountAssignmentCategory:p.catList[n].AccountAssignmentCategory,FixedSupplier:p.catList[n].FixedSupplier,ZZITEM:p.catList[n].ZZITEM})}}if(h.newList.length===0||h.newList.length===undefined){sap.ui.core.BusyIndicator.hide();var o=new sap.ui.model.json.JSONModel;this.getView().setModel(o,"MRP");t=this;jQuery.sap.require("sap.m.MessageBox");sap.m.MessageBox.show("No Records Found for date "+this.from+" to "+this.to,{icon:sap.m.MessageBox.Icon.ERROR,title:"Dear User",actions:[sap.m.MessageBox.Action.YES],onClose:function(e){if(e==="YES"){t.getView().byId("mb").setValue(null);return}}})}else{for(var u=0;u<h.newList.length;u++){if(h.newList[u].AccountAssignmentCategory!=="Y"){r[u]=h.newList[u].Material}}var c=r.filter(function(e,t,i){return i.indexOf(e)===t});var d=new sap.ui.model.Filter("MRPPlant",sap.ui.model.FilterOperator.EQ,s);var m=new sap.ui.model.Filter({filters:[d],and:true});var g=[];for(var M=0;M<c.length;M++){g.push(new sap.ui.model.Filter("Material",sap.ui.model.FilterOperator.EQ,c[M]))}var P=new sap.ui.model.Filter({filters:g,and:false});var f=new Array(new sap.ui.model.Filter({filters:[m,P],and:true}));a.read("/SupplyDemandItems",{async:false,filters:[f],success:function(e,t){var i=e.results;var a=i.length;for(var s=0;s<a;s++){v.zList.push({MRPElementCategoryName:i[s].MRPElementCategoryName,SourceMRPElementItem:i[s].SourceMRPElementItem,SourceMRPElement:i[s].SourceMRPElement,Material:i[s].Material,MRPPlant:i[s].MRPPlant,MRPElementAvailyOrRqmtDate:i[s].MRPElementAvailyOrRqmtDate,ExceptionMessageText:i[s].ExceptionMessageText});sap.ui.core.BusyIndicator.hide()}},error:function(e){sap.ui.core.BusyIndicator.hide()}})}}},onShow:function(e){var t=this.getView().byId("mb").getValue();if(this.bValid===undefined||this.bValid===false||t===undefined||t===""){sap.m.MessageToast.show("Please select valid Details");return}else{var i="Fetching Report data ...  ";l.show(i);sap.ui.core.BusyIndicator.show();var a=new Array;var s=new Array;var r=new Array;var n=this.getView().byId("btnId");var u={yList:[]};var c={jList:[]};var d={finalList:[]};var p=" ";for(var m=0;m<h.newList.length;m++){p=" ";if(h.newList[m].DeliveryDate===null){var g}else{g=JSON.stringify(h.newList[m].DeliveryDate);g=g.slice(1,11)}if(h.newList[m].RequestedDeliveryDate===null){var M}else{M=JSON.stringify(h.newList[m].RequestedDeliveryDate);M=M.slice(1,11)}for(var P=0;P<v.zList.length;P++){if(h.newList[m].PurchaseRequisition===v.zList[P].SourceMRPElement&&v.zList[P].MRPElementCategoryName==="Purchase requisition"&&h.newList[m].ZZITEM===v.zList[P].SourceMRPElementItem){p="X";d.finalList.push({MRPElementCategoryName:v.zList[P].MRPElementCategoryName,SourceMRPElementItem:v.zList[P].SourceMRPElementItem,SourceMRPElement:v.zList[P].SourceMRPElement,Material:v.zList[P].Material,MRPPlant:v.zList[P].MRPPlant,MRPElementAvailyOrRqmtDate:v.zList[P].MRPElementAvailyOrRqmtDate,ExceptionMessageText:v.zList[P].ExceptionMessageText,FixedSupplier:h.newList[m].FixedSupplier,DeliveryDate:g,RequestedDeliveryDate:M})}}if(p!=="X"){d.finalList.push({SourceMRPElement:h.newList[m].PurchaseRequisition,SourceMRPElementItem:h.newList[m].ZZITEM,Material:h.newList[m].Material,MRPPlant:h.newList[m].Plant,FixedSupplier:h.newList[m].FixedSupplier,DeliveryDate:g,RequestedDeliveryDate:M});p=" "}}}if(d.finalList.length<=0||d.finalList.length===undefined){sap.m.MessageToast.show("No Records Found");var f=new sap.ui.model.json.JSONModel;this.getView().setModel(f,"MRP")}else{o.setData(d);o.setSizeLimit(1e6);this.getView().setModel(o,"MRP")}sap.ui.core.BusyIndicator.hide()},onReset:function(e){var t=" ";this.getView().byId("mb").setValue(t);this.getView().byId("DRS3").setValue(t)},onClear:function(e){var t=" ";this.getView().byId("mb").setValue(t);this.getView().byId("DRS3").setValue(t)},onOpen:function(){var e=this.getView().getModel("i18n").getResourceBundle();var t=e.getText("Login").toString().trim();window.open(t,"_blank")},onDataExport:function(){var e=this.getView().getModel("MRP");var t=new s({exportType:new r({charset:"utf-8",fileExtension:"csv",separatorChar:",",mimeType:"application/csv"}),models:e,rows:{path:"/finalList"},columns:[{name:"Purchase Requisition",template:{content:"{SourceMRPElement}"}},{name:"Item",template:{content:"{SourceMRPElementItem}"}},{name:"Plant",template:{content:"{MRPPlant}"}},{name:"Material",template:{content:"{Material}"}},{name:"Supplier",template:{content:"{FixedSupplier}"}},{name:"Delivery Date",template:{content:"{DeliveryDate}"}},{name:"Actual need date",template:{content:"{ExceptionMessageText}"}},{name:"Requested Delivery Date",template:{content:"{RequestedDeliveryDate}"}}]});t.saveFile().catch(function(e){sap.m.MessageToast.show("Error")}).then(function(){t.destroy()})}})});